
# Микросервис Аналитики для Facebook Conversions API

Этот проект представляет собой Node.js микросервис, созданный с использованием Express.js, для отправки серверных событий в Facebook Conversions API (CAPI). Он позволяет собирать данные о действиях пользователей с вашего сайта или приложения и передавать их напрямую на серверы Facebook, что обеспечивает более надежное отслеживание по сравнению с клиентским Facebook Pixel, особенно в условиях ограничений браузеров и использования блокировщиков рекламы.


## Для чего этот проект?

В современном мире веб-аналитики и рекламы важно иметь точные данные о действиях пользователей. Клиентский Facebook Pixel, работающий в браузере пользователя, может быть заблокирован или его данные могут быть неполными из-за настроек приватности браузеров.

Facebook Conversions API (CAPI) позволяет отправлять события с вашего сервера напрямую в Facebook. Это решает многие проблемы клиентского отслеживания:

Надежность: События отправляются с вашего сервера, минуя браузерные ограничения.
Полнота данных: Вы можете обогащать события данными, доступными только на сервере.
Контроль: Вы полностью контролируете, какие данные и когда отправляются.
Конфиденциальность: Вы можете хешировать личные данные пользователей (PII) перед отправкой, повышая их безопасность.

Этот микросервис выступает в роли посредника: он принимает запросы от вашего основного приложения (фронтенда или другого бэкенда), обрабатывает их и безопасно отправляет в Facebook CAPI.

## Основные возможности

Прием событий через HTTP POST запрос.
Валидация обязательных полей события.
Автоматическое обогащение данных пользователя IP-адресом и User-Agent'ом.
Хеширование персональных данных пользователя (email, телефон, имя и т.д.) с использованием SHA256 перед отправкой в Facebook для защиты конфиденциальности.
Асинхронная отправка событий в Facebook CAPI (сервис отвечает клиенту сразу, а отправка в Facebook происходит в фоне).
Поддержка тестовых событий Facebook (FB_TEST_EVENT_CODE) для отладки в Events Manager.
Гибкая конфигурация через переменные окружения (.env файл).
Настраиваемый CORS для безопасного взаимодействия с фронтендом.
Подробное логирование процессов для отладки.

## Технологический стек

Node.js: Среда выполнения JavaScript.
Express.js: Веб-фреймворк для Node.js.
axios: HTTP-клиент для отправки запросов к Facebook API.
dotenv: Для загрузки переменных окружения из .env файла.
crypto: Встроенный модуль Node.js для хеширования данных.

### Прежде чем начать (Требования)

Node.js и npm (или yarn): Убедитесь, что на вашем компьютере или сервере установлены Node.js (рекомендуется версия LTS) и менеджер пакетов npm (обычно идет в комплекте с Node.js) или yarn.

Facebook Pixel ID: Вам нужен идентификатор вашего Facebook Pixel. Его можно найти в Facebook Events Manager.

Facebook Access Token: Вам нужен токен доступа для Conversions API. Инструкции по его получению можно найти в официальной документации Facebook для разработчиков (https://developers.facebook.com/docs/marketing-api/conversions-api/get-started#access-token).
Важно: Храните этот токен в секрете! Не добавляйте его напрямую в код.

(Опционально) Facebook Test Event Code: Если вы хотите тестировать события в Events Manager, вам понадобится тестовый код события.

## Установка и запуск

Клонирование репозитория

Если у вас есть git, клонируйте репозиторий:

´´´
git clone <URL_вашего_репозитория>
cd <имя_папки_проекта>
´´´

Если вы получили код в виде архива, распакуйте его.

## Установка зависимостей

Перейдите в корневую папку проекта и установите все необходимые пакеты:

´´´
npm install
´´´

## Конфигурация (файл .env)

Этот проект использует файл .env для хранения конфигурационных переменных, включая секретные ключи.

Создайте файл с именем .env в корневой директории проекта.

Скопируйте содержимое из файла .env.example (если он есть) или добавьте следующие строки, заменив значения на ваши:

Порт, на котором будет работать микросервис
PORT=3002

Учетные данные Facebook Conversions API
FB_PIXEL_ID=ВАШ_FACEBOOK_PIXEL_ID
FB_ACCESS_TOKEN=ВАШ_FACEBOOK_ACCESS_TOKEN
FB_API_VERSION=v19.0 Или актуальная версия API

Опционально: Тестовый код события для отладки в Facebook Events Manager
Если оставить пустым, тестовый режим не будет использоваться.
FB_TEST_EVENT_CODE=TESTXXXXX

Опционально: Список разрешенных источников для CORS (через запятую)
Если ваш фронтенд работает на http://localhost:3000, добавьте его.
Если не указано, CORS может блокировать запросы от браузеров с других доменов.
Для разработки локально часто оставляют пустым или разрешают '*' (не рекомендуется для продакшена без понимания рисков)
ALLOWED_ORIGINS=http://localhost:3000,https://your-frontend-domain.com

PORT: Порт, на котором будет запущен сервер.
FB_PIXEL_ID: Идентификатор вашего Facebook Pixel.
FB_ACCESS_TOKEN: Ваш токен доступа к CAPI. Это секрет!
FB_API_VERSION: Версия Facebook Graph API (например, v19.0). Проверяйте актуальную версию в документации Facebook.
FB_TEST_EVENT_CODE: (Опционально) Тестовый код для проверки событий в Facebook Events Manager.
ALLOWED_ORIGINS: (Опционально) Список доменов (через запятую), с которых разрешены запросы (CORS). Важно для безопасности в продакшене.

Важно: Файл .env не должен попадать в систему контроля версий (он уже должен быть в .gitignore).

## Запуск сервера

После установки зависимостей и настройки .env файла, вы можете запустить сервер:

´´´
npm start
или если вы используете nodemon для разработки
npm run dev (если есть такой скрипт в package.json)
´´´

Вы должны увидеть в консоли сообщения о том, что сервер успешно запущен и слушает указанный порт, а также статус конфигурации CAPI.

## Проверка работоспособности

Откройте браузер или используйте инструмент вроде Postman/Insomnia и перейдите по адресу:

http://localhost:ВАШ_PORT/api/v1/analytics/ping

(Замените ВАШ_PORT на значение из вашего .env файла, например, 3002).

Вы должны получить JSON-ответ:

{
"success": true,
"message": "Analytics routes are alive!"
}

Это означает, что сервер работает и маршруты аналитики доступны.

API Эндпоинты

POST /api/v1/analytics/track

Основной эндпоинт для отправки событий.

Метод: POST
Content-Type: application/json

Тело запроса (Request Body):

´´´json
{
"eventName": "Purchase",
"eventId": "unique_event_id_12345",
"eventSourceUrl": "https://yourdomain.com/thank-you-page",
"eventTime": 1678886400,
"userData": {
"email": "user@example.com",
"phone": "1234567890",
"firstName": "John",
"lastName": "Doe",
"fbp": "fb.1.1558571054389.1098115397",
"fbc": "fb.1.1554763741205.AbCdEfGhIjKlMnOpQrStUvWxYz"
},
"customData": {
"value": 199.99,
"currency": "USD",
"content_ids": ["product_id_1", "product_id_2"],
"content_type": "product"
}
}
´´´

Поля в req.body:

eventName (String, обязательное): Имя события (например, Lead, Purchase, ViewContent). Список стандартных событий см. в документации Facebook.
eventId (String, обязательное): Уникальный идентификатор события. Facebook использует его для дедупликации событий, если одно и то же событие будет отправлено несколько раз (например, через Pixel и CAPI).
eventSourceUrl (String, обязательное): Полный URL страницы, на которой произошло событие.
eventTime (Number, опциональное): Время, когда произошло событие, в формате Unix timestamp (секунды). Если не предоставлено, сервис использует текущее время сервера.
userData (Object, опциональное, но настоятельно рекомендуется): Объект с данными пользователя. Чем больше данных вы предоставите (в хешированном виде), тем лучше Facebook сможет сопоставить событие с пользователем.
Включает поля: email, phone, firstName, lastName, fbp (cookie _fbp), fbc (cookie _fbc), city, st (штат), zp (почтовый индекс), country и т.д.
Сервис автоматически хеширует эти данные перед отправкой в Facebook.
Сервис также автоматически добавит client_ip_address и client_user_agent.
customData (Object, опциональное): Объект с дополнительными данными, специфичными для события (например, стоимость покупки, валюта, идентификаторы товаров).

Пример использования с cURL:

´´´curl
curl -X POST http://localhost:3002/api/v1/analytics/track
-H "Content-Type: application/json"
-d '{
"eventName": "Lead",
"eventId": "lead_form_submission_xyz789",
"eventSourceUrl": "https://yourdomain.com/contact-us",
"userData": {
"email": "testuser@example.com",
"phone": "5551234567",
"firstName": "Test",
"lastName": "User"
},
"customData": {
"form_id": "contact_form_v1"
}
}'
´´´

Ответ сервера:

Успех (202 Accepted):
Сервер немедленно отвечает, что запрос принят и поставлен в очередь на обработку (отправку в Facebook). Это не означает, что событие уже успешно доставлено в Facebook, а лишь то, что сервис его получил.

{
"success": true,
"message": "Event 'Lead' (ID: lead_form_submission_xyz789) received and queued for processing.",
"eventId": "lead_form_submission_xyz789"
}

Ошибка валидации (400 Bad Request):
Если отсутствуют обязательные поля (eventName, eventId, eventSourceUrl).

{
"success": false,
"error": "Missing required fields: eventName, eventId, and eventSourceUrl are required."
}

Другие ошибки сервера (500 Internal Server Error):
В случае непредвиденных ошибок на сервере. Подробности будут в логах сервера.

´´´
GET /api/v1/analytics/ping
´´´

Простой эндпоинт для проверки, что сервис запущен и доступен.

Метод: GET

Ответ сервера (200 OK):

´´´json
{
"success": true,
"message": "Analytics routes are alive!"
}
´´´

## Как это работает? (Архитектура)

Клиент (Ваш сайт/приложение): Отправляет HTTP POST запрос с данными о событии на эндпоинт /api/v1/analytics/track этого микросервиса.

analyticsRoutes.js: Маршрутизатор Express принимает запрос и передает его соответствующему контроллеру.

analyticsController.js (trackEventHandler):
Извлекает данные из тела запроса (req.body).
Проводит базовую валидацию (проверяет наличие обязательных полей).
Получает IP-адрес (client_ip_address) и User-Agent (client_user_agent) клиента из заголовков запроса.
Обогащает объект userData этими данными.
Асинхронно вызывает функцию sendEventToFacebook из facebookCapiService.js.
Немедленно отправляет клиенту ответ HTTP 202 Accepted, подтверждая получение события.

facebookCapiService.js (sendEventToFacebook):
Эта функция выполняется в фоновом режиме, не блокируя ответ клиенту.
Получает все данные о событии.
Хеширует значения из userData (email, phone и т.д.) с помощью SHA256.
Формирует JSON-payload в соответствии со спецификацией Facebook Conversions API.
Если в .env указан FB_TEST_EVENT_CODE, добавляет его в payload для тестирования.
Используя axios, отправляет HTTP POST запрос на API-эндпоинт Facebook (https://graph.facebook.com/VERSION/PIXEL_ID/events?access_token=TOKEN).
Логирует результат ответа от Facebook (успех или ошибка).

Facebook: Получает событие, обрабатывает его и (если все корректно) отображает в Events Manager вашего Pixel.

## Ключевые концепции для понимания

### Facebook Conversions API (CAPI)

Это инструмент Facebook, который позволяет бизнесам отправлять веб-события со своих серверов напрямую в Facebook. Это дополнение к Facebook Pixel (который работает в браузере) и помогает повысить точность отслеживания и эффективность рекламы.

### Хеширование данных (PII)

PII (Personally Identifiable Information) – это личные данные пользователя, такие как email, телефон, имя, адрес. Facebook требует, чтобы такие данные передавались в CAPI в хешированном виде (например, с использованием SHA256).

Что такое хеширование? Это односторонний процесс преобразования данных в строку символов фиксированной длины. Из хеша невозможно восстановить исходные данные.
Зачем это нужно? Для защиты конфиденциальности пользователей. Facebook сопоставляет хешированные данные с данными своих пользователей, не видя исходных PII.
В этом проекте сервис автоматически хеширует поля email, phone, firstName, lastName и другие подобные поля перед отправкой.

### Асинхронная отправка

Когда ваш сайт отправляет событие в этот микросервис, микросервис очень быстро отвечает "ОК, я получил событие" (HTTP 202). Сама же отправка данных в Facebook происходит "в фоне" (асинхронно).

Преимущества: Ваш сайт не "зависает" в ожидании ответа от Facebook, что улучшает пользовательский опыт. Микросервис может обрабатывать больше запросов.

CORS (Cross-Origin Resource Sharing)

Если ваш фронтенд (сайт) и этот микросервис работают на разных доменах (или портах на localhost), браузер по соображениям безопасности может блокировать запросы от фронтенда к микросервису. CORS — это механизм, который позволяет серверу указать, каким другим доменам разрешено делать к нему запросы.

В этом проекте CORS настраивается через переменную ALLOWED_ORIGINS в файле .env.

## Логирование и отладка

Микросервис выводит подробные логи в консоль на каждом этапе обработки запроса:

Загрузка модулей.
Получение запроса, его метод, URL, заголовки и тело.
Информация о клиенте (IP, User-Agent).
Этапы подготовки данных для Facebook (включая использование тестового кода).
Отправка запроса в Facebook API.
Ответ от Facebook API.

Для отладки интеграции с Facebook:

Используйте FB_TEST_EVENT_CODE: Укажите ваш тестовый код в .env. Затем откройте Facebook Events Manager для вашего пикселя, перейдите на вкладку "Test Events". События, отправленные с этим кодом, должны появиться там в реальном времени с подробной информацией.

Проверяйте логи сервера: Если событие не доходит до Facebook или приходит с ошибками, логи сервера предоставят ценную информацию о проблеме (например, неправильный токен, неверный формат данных, ошибки сети).

## Структура проекта
́´´´
.
├── controllers/
│ └── analyticsController.js Логика обработки запросов (контроллеры)
├── routes/
│ └── analyticsRoutes.js Определение API маршрутов
├── services/
│ └── facebookCapiService.js Логика взаимодействия с Facebook CAPI
├── .env Файл конфигурации (создается вручную)
├── .gitignore Файлы, игнорируемые Git
├── app.js Главный файл приложения, настройка Express
├── package.json Зависимости проекта и скрипты
└── README.md Этот файл
´´´

app.js: Инициализация Express-приложения, подключение middleware (CORS, парсеры), глобальные обработчики ошибок, запуск сервера.
routes/analyticsRoutes.js: Определяет маршруты (/track, /ping) и связывает их с функциями-обработчиками в контроллере.
controllers/analyticsController.js: Содержит функции-обработчики для каждого маршрута. Отвечает за получение данных из запроса, их валидацию и вызов соответствующего сервиса.
services/facebookCapiService.js: "Сердце" интеграции с Facebook. Содержит логику формирования запроса к CAPI, хеширования данных и отправки HTTP-запроса.
.env: Хранит конфигурационные переменные, включая секреты. Не добавляйте его в Git!

## Дальнейшее развитие (Возможные улучшения)

Очередь сообщений: Для очень высокой нагрузки можно интегрировать систему очередей (например, RabbitMQ, Redis, Kafka) для более надежной обработки событий и повторных попыток в случае сбоев.
Более продвинутая валидация: Использовать библиотеки типа Joi или Zod для строгой валидации входящих данных.
Пакетная отправка событий: Facebook CAPI поддерживает отправку нескольких событий в одном запросе, что может быть эффективнее.
Управление ошибками и повторные попытки: Реализовать механизм повторных попыток отправки в Facebook в случае временных сетевых ошибок.
Мониторинг и метрики: Добавить сбор метрик (например, количество успешных/неуспешных отправок) с использованием Prometheus/Grafana.
Расширенное логирование: Интеграция с системами централизованного логирования (ELK Stack, Grafana Loki).
Аутентификация/Авторизация для API: Если микросервис будет доступен извне, добавить механизм защиты эндпоинтов (например, API ключи).
Docker-контейнеризация: Упаковать приложение в Docker-контейнер для упрощения развертывания.

Надеюсь, эта документация будет полезна!